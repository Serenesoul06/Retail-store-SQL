CREATE DATABASE RETAIL
USE RETAIL
--DATA IS IMPORTED USING IMPORT WIZARD

--DATA UNDERSTANDING QUESTIONS--
--Q.1 WHAT IS THE TOTAL NUMBER OF ROWS IN EACH OF THE THREE TABLES IN THE DATABASE?

SELECT 'CUSTOMER' AS TABLE_NAME, COUNT(*) AS NO_OF_RECORDS FROM CUSTOMER
SELECT 'TRANSACTION' AS TABLE_NAME, COUNT(*) AS NO_OF_RECORDS FROM [TRANSACTION]
SELECT 'PRODUCT' AS TABLE_NAME, COUNT(*) AS NO_OF_RECORDS FROM PRODUCT

--Q.2 WHAT IS THE TOTAL NUMBER OF TRANSACTIONS THAT HAVE A RETURN?

SELECT COUNT(transaction_id) [TOTAL RETURN TRANSACTIONS]
FROM [TRANSACTION]
WHERE QTY<0 

--Q.3 AS YOU WOULD HAVE NOTICED THE DATES PROVIDES ACROSS THE DATASETS ARE 
--NOT IN THE CORRECT FORMAT. AS A FIRST STEP, CONVERT THE DATE VARIABLES INTO
--VALID DATE FORMATS BEFORE PROCEEDING AHED.
--ANS
--ALREADY CONVERTED INTO DATE FORMAT WHILE EXTRACING THE DATA.
--THIS GOES MUCH EASIER RATHER THAN CONVERTING IT AFTERWARDS.
SELECT * FROM TBL_CUSTOMER 
SELECT* FROM TBL_TRANSACTIONS
SELECT CONVERT(DATE,'10-09-1994')

--Q.4 WHAT IS THE TIME RANGE OF THE TRANSACTION DATA AVAILABLE FOR ANALYSIS? 
--SHOW THE OUTPUT IN NUMBER OF DAYS, MONTHS AND YEARS SIMLUTANEOUSLY IN DIFFERENT 
--COLUMNS.

SELECT 
datediff(day,MIN(TRAN_DATE),MAX(TRAN_DATE)) [DAYS],
datediff(month,MIN(TRAN_DATE),MAX(TRAN_DATE)) [MONTHS],
datediff(year,MIN(TRAN_DATE),MAX(TRAN_DATE)) [YEARS]
FROM [TRANSACTION]


--Q.5 WHICH PRODUCT CATEGORY DOES THE SUB_CATEGORY 'DIY' BELONG TO?

SELECT PROD_CAT [PRODUCT CATEGORY] 
FROM PRODUCT
WHERE prod_subcat='DIY'

--DATA ANALYSIS QUESTIONS--
--Q.1 WHICHH CHANNEL IS MOST FREQUENTLY USED FOR TRANSACTION?

SELECT TOP 1 
STORE_TYPE,
COUNT(transaction_id) [NUMBER OF TRANSACTIONS]
FROM [TRANSACTION]
GROUP BY Store_type 
ORDER BY COUNT(transaction_id) DESC

--Q.2 WHAT IS THE COUNT OF MALE AND FEMALE CUSTOMERS IN THE DATABASE?

SELECT TOP 2
GENDER,
COUNT(GENDER) [NO_OF_CUSTOMERS]
FROM CUSTOMER
GROUP BY Gender
ORDER BY [NO_OF_CUSTOMERS] DESC

--Q.3 FROM WHICH CITY DO WE HAVE MAXIMUM NUMBER OF CUSTOMERS AND HOW MANY?

SELECT TOP 1
CITY_CODE,
COUNT(CUSTOMER_ID) [NUMBER OF CUSTOMERS]
FROM CUSTOMER
GROUP BY city_code
ORDER BY [NUMBER OF CUSTOMERS] DESC

--Q.4 HOW MANY SUB CATEGORIES ARE THERE UNDER THE BOOKS CATEGORY?

SELECT 
PROD_CAT,
COUNT(PROD_SUB_CAT_CODE) [NUMBER OF SUB-CATEGORIES]
FROM PRODUCT
WHERE PROD_CAT='BOOKS'
GROUP BY prod_cat

--Q.5 WHAT IS THE MAXIMUM QUANTITY OF PRODUCTS EVER ORDERED PER CUSTOMER 
--IN A SINGLE TRANSACTION?
/* DO NOT USE SUM(QTY) FOR ALL TRANSACTIONS DONE BY A SINGLE CUSTOMER*/

SELECT 
CUST_ID, 
MAX(QTY) [PRODUCT QUANTITY ORDERED]
FROM [TRANSACTION]
WHERE QTY>0
GROUP BY CUST_ID
ORDER BY [PRODUCT QUANTITY ORDERED] DESC, CUST_ID ASC

--Q.6 WHAT IS THE NET TOTAL REVENUE GENERATED BY CATEGORIES- ELECTRONICS AND BOOKS?
--WITHOUT TAX

SELECT  
T2.prod_cat,
SUM(T1.QTY*ABS(T1.Rate)) [TOTAL_REVENUE_OF_STORE]
FROM [TRANSACTION] T1 LEFT JOIN PRODUCT T2 
ON T1.prod_cat_code=T2.prod_cat_code AND T1.prod_subcat_code=T2.prod_sub_cat_code
WHERE prod_cat IN ('ELECTRONICS', 'BOOKS')
GROUP BY T2.prod_cat 

--Q.7 HOW MANY CUSTOMERS HAVE MORE THAN 10 TRANSACTIONS WITH US, EXLUDING RETURNS?

SELECT 
cust_id [CUSTOMER_ID],
COUNT(TRANSACTION_ID) [NUMBER OF TRANSACTIONS]
FROM [TRANSACTION]
WHERE QTY>0
GROUP BY cust_id
HAVING COUNT(TRANSACTION_ID)>10


--Q.8 WHAT IS COMBINED REVENUE EARNED FROM 'ELECTRONICS' AND 'CLOTHING' CATEGORIES 
--FROM FLAGSHIP STORES?

SELECT SUM(T3.[CATEGORYWISE_REVENUE])  [COMBINED REVENUE] 
FROM (SELECT  
T2.prod_cat,
SUM(T1.QTY*ABS(T1.Rate)) [CATEGORYWISE_REVENUE]
FROM [TRANSACTION] T1 LEFT JOIN PRODUCT T2 
ON T1.prod_cat_code=T2.prod_cat_code AND T1.prod_subcat_code=T2.prod_sub_cat_code
WHERE prod_cat IN ('ELECTRONICS', 'CLOTHING') AND Store_type='FLAGSHIP STORE'
GROUP BY T2.prod_cat ) T3

--Q.9 WHAT IS THE TOTAL REVENUE GENERATED FROM 'MALE' CUSTOMERS IN 'ELECTRONICS' CATEGORY?
--OUTPUT SHOULD DISPLAY TOTAL REVENUE BY PRODUCT SUB-CATEGORY.

SELECT  
T2.prod_subcat,
SUM(T1.QTY*ABS(T1.Rate)) [CATEGORYWISE_REVENUE]
FROM [TRANSACTION] T1 LEFT JOIN PRODUCT T2 
ON T1.prod_cat_code=T2.prod_cat_code AND T1.prod_subcat_code=T2.prod_sub_cat_code
                      LEFT JOIN CUSTOMER T3 ON cust_id=customer_Id
WHERE  T2.prod_cat='ELECTRONICS' AND GENDER='M'
GROUP BY T2.prod_subcat 


--Q.10 WHAT IS PERCENTAGE OF SALES AND RETURNS BY PRODUCT SUB_CATEGORY?
--DISPLAY ONLY TOP 5 CATEGORIES IN TERMS OF SALES
--% sale and and returns on qty

SELECT TOP 5
T1.prod_cat_code,
T1.prod_subcat_code,
(T1.QTY)*100.00000/(T1.QTY+ T2.QTY) [RETURN PERCENT],
(T2.QTY)*100.00000/(T1.QTY+ T2.QTY) [SALES PERCENT],
T2.[SALES AMT] [SALES AMOUNT]
FROM (SELECT
prod_cat_code,
prod_subcat_code,
SUM(ABS(Qty)) [QTY],
SUM(total_amt) [SALES AMT]
FROM [TRANSACTION] 
WHERE QTY<0
GROUP BY prod_cat_code,
prod_subcat_code)  T1
LEFT JOIN 
(SELECT
prod_cat_code,
prod_subcat_code,
SUM(ABS(Qty)) [QTY],
SUM(total_amt)[SALES AMT]
FROM [TRANSACTION] 
WHERE QTY>0
GROUP BY prod_cat_code,
prod_subcat_code) T2 ON T1.prod_cat_code=T2.prod_cat_code 
                        AND T1.prod_subcat_code=T2.prod_subcat_code
ORDER BY [SALES AMOUNT] DESC


--Q.11 FOR ALL CUSTOMERS AGED BETWEEN 25 TO 35 YEARS, FIND WHAT IS THE NET TOTAL REVENUE 
--GENERATED BY THESE CONSUMERS IN LAST 30 DAYS OF TRANSACTIONS FROM MAX TRANSACTION DATE
--AVAILABLE IN THE DATA.

SELECT  
customer_Id, DOB,
SUM((QTY*ABS(RATE))) [REVENUE],
DATEDIFF(YEAR, DOB, CAST(CURRENT_TIMESTAMP AS DATE)) [CONSUMER'S_AGE]
FROM [TRANSACTION] T1 LEFT JOIN CUSTOMER T2 ON T1.cust_id=T2.customer_Id
WHERE T1.TRAN_DATE <=(SELECT MAX(TRAN_DATE) FROM [TRANSACTION]) 
AND T1.TRAN_DATE >=(SELECT DATEADD(DAY, -30,MAX(TRAN_DATE) )FROM [TRANSACTION]) 
GROUP BY customer_Id, DOB
HAVING DATEDIFF(YEAR, DOB, CAST(CURRENT_TIMESTAMP AS DATE)) BETWEEN '25' AND '35'
ORDER BY customer_Id ASC


--Q.12 WHICH PRODUCT CATEGORY HAS SEEN THE MAXIMUM VALUE OF RETURNS IN THE LAST 3 MONTHS 
--OF TRANSACTIONS?

SELECT TOP 1
T2.prod_cat [CATEGORY],
T2.prod_cat_code [PROD_CAT_CODE],
ABS(SUM(QTY)) [TOTAL_RETURNS]
FROM [TRANSACTION] T1 LEFT JOIN [PRODUCT] T2 ON T1.prod_cat_code=T2.prod_cat_code AND 
								  T1.prod_subcat_code=T2.prod_sub_cat_code
WHERE QTY<0  AND  
T1.tran_date>=(SELECT DATEADD(DAY,-90,MAX(TRAN_DATE)) FROM [TRANSACTION] T3 
WHERE T3.prod_cat_code=T1.prod_cat_code) 
AND T1.tran_date<=(SELECT 
MAX(TRAN_DATE) FROM [TRANSACTION] T4 WHERE T4.prod_cat_code=T1.prod_cat_code) 
GROUP BY T2.prod_cat ,
T2.prod_cat_code 
ORDER BY [TOTAL_RETURNS] DESC


--Q.13 WHICH STORE TYPE SELLS THE MAXIMUM PRODUCTS? BY VALUE OF SALES AMOUNT AND BY 
--QUANTITY SOLD.

SELECT TOP 1
STORE_TYPE,
SUM(QTY) [QUANTITY SOLD],
SUM(TOTAL_AMT) [TOTAL SALES AMOUNT]
FROM [TRANSACTION]
WHERE QTY>0
GROUP BY Store_type
ORDER BY [TOTAL SALES AMOUNT] DESC, [QUANTITY SOLD] DESC


--Q.14 WHAT ARE THE CATEGORIES FOR WHICH AVERAGE REVENUE IS ABOVE THE OVERALL AVERAGE?

SELECT T2.prod_cat, AVG(T1.QTY*ABS(T1.Rate)) [AVG_REVENUE]
FROM  [TRANSACTION] T1 LEFT JOIN PRODUCT T2 ON
                                  T1.prod_cat_code=T2.prod_cat_code AND 
								  T1.prod_subcat_code=T2.prod_sub_cat_code
GROUP BY T2.prod_cat
HAVING AVG(T1.QTY*ABS(T1.Rate))> (SELECT AVG(QTY*ABS(Rate)) 
                       FROM [TRANSACTION])

--Q.15 FIND THE TOTAL AND AVERAGE REVENUE BY EACH SUBCATEGORY FOR THE CATEGORIES WHICH ARE 
--AMONG TOP 5 CATEGORIES IN TERMS OF QUANTITY SOLD.

SELECT 
T4.CATEGORY,
T3.prod_subcat_code,
AVG(T3.QTY*ABS(T3.Rate)) [AVG REVENUE BY SUB_CAT],
SUM(T3.QTY*ABS(T3.Rate)) [SUM OF REVENUE BY SUB_CAT]
FROM [TRANSACTION] T3,
(SELECT TOP 5
T2.prod_cat [CATEGORY],
T1.prod_cat_code [CAT_CODE],
SUM(T1.QTY) [QUANTITY SOLD]
FROM [TRANSACTION] T1 LEFT JOIN PRODUCT T2 ON
                                  T1.prod_cat_code=T2.prod_cat_code AND 
								  T1.prod_subcat_code=T2.prod_sub_cat_code
GROUP BY T2.prod_cat,T1.prod_cat_code
ORDER BY [QUANTITY SOLD] DESC) T4
WHERE T4.[CAT_CODE] = T3.prod_cat_code
GROUP BY T4.CATEGORY,
T3.prod_subcat_code
ORDER BY T4.CATEGORY ASC
